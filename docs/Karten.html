<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Geodaten und Karten in R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">IW-R-Kurs</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="Ziele.html">Ziele</a>
</li>
<li>
  <a href="Einführung.html">Einführung</a>
</li>
<li>
  <a href="Tidyverse.html">Tidyverse</a>
</li>
<li>
  <a href="ggplot.html">ggplot2</a>
</li>
<li>
  <a href="Mikrodatenanalyse_Workflow.html">Mikrodatenanalyse</a>
</li>
<li>
  <a href="Karten.html">Karten und Geodaten</a>
</li>
<li>
  <a href="Links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Geodaten und Karten in R</h1>

</div>


<hr />
<div id="ziele-der-sitzung" class="section level1">
<h1>Ziele der Sitzung</h1>
<ul>
<li>Visualisierung von räumlichen Daten</li>
<li>Erstellen von Karten im <em>printfähigen</em> Format</li>
</ul>
<hr />
</div>
<div id="geodaten-leicht-gemacht" class="section level1">
<h1>Geodaten leicht gemacht</h1>
<p>Die Visualisierung von simplen Geoinformationen unterscheidet sich nicht wesentlich von der Visualisierung anderer Daten. Bei Punktdaten im zweidimensionalen Raum bedarf es beispielsweise eines x-Wertes und eines y-Wertes, um diesen zu visualisieren. Übertragen auf die Erdkugel bedarf es eines Längen- und Breitengrades. Hinzu kommt eine <em>Projektion</em> vgl. z.B. <a href="https://de.wikipedia.org/wiki/Mercator-Projektion">Mercator-Projektion</a>.</p>
<p>Geodaten werden in vielerlei Formen bereitgestellt. Zu den häufig verwendeten gehört das Shapefile-Format von ESRI. In der <code>.shp</code>-Datei sind die Geometriedaten gespeichert. Eine Shapefile ist jedoch keine einzelne Datei, sonder besteht aus mindestens drei einzelnen Dateien, die im selben Ordner gespeichert werden sollten.</p>
<p>In der sozialwissenschaftlichen und ökonomischen Forschung werden in der Regel entweder Polygone oder Punktdaten visualisiert.</p>
<p>Zum Einlesen von Shapefiles nutzen wir das Paket <code>sf</code>. Mit <code>st_read</code> lesen wir ein Shapefile ein.</p>
<pre class="r"><code>#Quelle Shapefile Bundesländer: https://opendata-esri-de.opendata.arcgis.com/datasets/esri-de-content::bundesl%C3%A4nder-2016-mit-einwohnerzahl?geometry=-31.360%2C46.270%2C52.268%2C55.886
library(tidyverse)
library(sf)
bundeslaender &lt;- st_read(&quot;daten_beispiele/shapefiles_bundeslaender/Bundesländer_2016_ew.shp&quot;)</code></pre>
<pre><code>## Reading layer `BundeslÃ¤nder_2016_ew&#39; from data source `C:\Users\amertens\IW-R-Kurs\daten_beispiele\shapefiles_bundeslaender\BundeslÃ¤nder_2016_ew.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 16 features and 21 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 653028 ymin: 5986277 xmax: 1674447 ymax: 7373205
## projected CRS:  WGS 84 / Pseudo-Mercator</code></pre>
<p>Beim Einlesen eines Shapefiles werden bereits wichtige Informationen zum Geometrietyp und der Projektion angezeigt.</p>
<p>#Visualisierung von Geodaten Eine einfache, der Syntax von <code>ggplot2</code> folgende Visualisierung von Geodaten kann mit dem <code>geom_sf</code> erreicht werden. Als <code>aesthetic</code> wird eine <code>geometry</code> benötigt. In diesem Fall heißt die entsprechende Spalte im Datensatz ebenfalls <em>geometry</em>.</p>
<pre class="r"><code>bundeslaender %&gt;%
  ggplot(aes(geometry = geometry)) +
  geom_sf()</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Sollen die Polygone, in diesem Fall Bundesländer mit einem Farbwert, der auf einer Variabel basiert, gefüllt werden, so geschieht dies mit der <code>fill</code>-aesthetic. Der Datensatz enthält eine Spalte <code>EWZ</code> mit der Einwohnerzahl je Bundesland.</p>
<pre class="r"><code>bundeslaender %&gt;%
  ggplot(aes(geometry = geometry, fill = EWZ)) +
  geom_sf() +
  scale_fill_continuous(labels = function(x) format(x, big.mark = &quot;.&quot;, decimal.mark = &quot;,&quot;, scientific = FALSE)) #verhindert Exponentialnotation und stellt auf deutsche Kommas um</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Das <em>Schichtprinzip</em> von ggplot2, nachdem einer Abbildung mit <code>+</code> weitere Schichten hinzugefügt werden können funktioniert bei der Visualisierung von Geodaten ebenfalls.</p>
<p>Hier muss jedoch zusätzlich darauf geachtet werden, dass die verschiedenen Informationen, die übereinander dargestellt werden in derselben Projektion gespeichert wurden.</p>
<p>Wir laden zunächst ein neues Shapefile, das Standorte von Krankenhäusern im Ruhrgebiet enthält. Die Daten zu Krankenhäusern stammen aus dieser Quelle: <a href="https://www.govdata.de/web/guest/suchen/-/details/poi-krankenhauser">GovData</a></p>
<pre class="r"><code>krankenhaeuser &lt;- st_read(&quot;daten_beispiele/krankenhaeuser_ruhr/poi_krankenhaeuser.shp&quot;)</code></pre>
<pre><code>## Reading layer `poi_krankenhaeuser&#39; from data source `C:\Users\amertens\IW-R-Kurs\daten_beispiele\krankenhaeuser_ruhr\poi_krankenhaeuser.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 554 features and 44 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 309435.8 ymin: 5627418 xmax: 422184.5 ymax: 5739012
## projected CRS:  ETRS89 / UTM zone 32N</code></pre>
<p>Die Visualisierung der Punktdaten unterscheidet sich in der Syntax nicht von der von Polygonen.</p>
<pre class="r"><code>krankenhaeuser %&gt;%
  ggplot(aes(geometry = geometry)) +
  geom_sf()</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Eine Darstellung der Punktdaten ohne eine Grundkarte macht wenig Sinn. Wo liegen die Punkte? Um die Grundkarte der Bundesländer und die Standorte der Krankenhäuser gemeinsam darzustellen, überprüfen wir zunächst, ob diese dieselbe Projektion haben.</p>
<p>Ein Vergleich der beiden Projektionen zeigt, dass diese nicht identisch sind*:</p>
<pre class="r"><code>waldo::compare(bundeslaender %&gt;% sf::st_crs(), krankenhaeuser %&gt;% sf::st_crs())</code></pre>
<pre><code>## `old$input`: &quot;WGS 84 / Pseudo-Mercator&quot;
## `new$input`: &quot;ETRS89 / UTM zone 32N&quot;   
## 
## lines(old$wkt[[1]])[1:21] vs lines(new$wkt[[1]])[1:24]
## - &quot;PROJCRS[\&quot;WGS 84 / Pseudo-Mercator\&quot;,&quot;
## + &quot;PROJCRS[\&quot;ETRS89 / UTM zone 32N\&quot;,&quot;
## - &quot;    BASEGEOGCRS[\&quot;WGS 84\&quot;,&quot;
## + &quot;    BASEGEOGCRS[\&quot;ETRS89\&quot;,&quot;
## - &quot;        DATUM[\&quot;World Geodetic System 1984\&quot;,&quot;
## + &quot;        DATUM[\&quot;European Terrestrial Reference System 1989\&quot;,&quot;
## - &quot;            ELLIPSOID[\&quot;WGS 84\&quot;,6378137,298.257223563,&quot;
## + &quot;            ELLIPSOID[\&quot;GRS 1980\&quot;,6378137,298.257222101,&quot;
##   &quot;                LENGTHUNIT[\&quot;metre\&quot;,1]]],&quot;
##   &quot;        PRIMEM[\&quot;Greenwich\&quot;,0,&quot;
## and 14 more ...
## 
## lines(old$wkt[[1]])[22:35] vs lines(new$wkt[[1]])[25:38]
##   &quot;            LENGTHUNIT[\&quot;metre\&quot;,1],&quot;
##   &quot;            ID[\&quot;EPSG\&quot;,8807]]],&quot;
##   &quot;    CS[Cartesian,2],&quot;
## - &quot;        AXIS[\&quot;easting (X)\&quot;,east,&quot;
## + &quot;        AXIS[\&quot;(E)\&quot;,east,&quot;
##   &quot;            ORDER[1],&quot;
##   &quot;            LENGTHUNIT[\&quot;metre\&quot;,1]],&quot;
## - &quot;        AXIS[\&quot;northing (Y)\&quot;,north,&quot;
## + &quot;        AXIS[\&quot;(N)\&quot;,north,&quot;
##   &quot;            ORDER[2],&quot;
## and 4 more ...</code></pre>
<p>*Anmerkung: Unterschiede sind nicht immer leicht zu erkennen und manchmal unterscheiden sich auch nur die Bezeichnungen (vgl. <a href="https://de.wikipedia.org/wiki/UTM-Koordinatensystem#:~:text=Die%20Arbeitsgemeinschaft%20der%20Vermessungsverwaltungen%20der,Lagebezugssystem%20f%C3%BCr%20ganz%20Deutschland%20beschlossen.">UTM-Koordinatensystem</a>)</p>
<p>Das Paket <code>sf</code> bietet eine Vielzahl an Funktionen, um mit Geoinformationen zu arbeiten. Die Funktion <code>st_transform</code> erlaubt uns die Projektionen zu ändern.</p>
<pre class="r"><code>bundeslaender_wgs84 &lt;- bundeslaender %&gt;%
  st_transform(crs = 4326)</code></pre>
<pre class="r"><code>krankenhaeuser_wgs84 &lt;- krankenhaeuser %&gt;%
  st_transform(crs = 4326)</code></pre>
<p>Nun haben die beiden Datensätze dieselbe Projektion…</p>
<pre class="r"><code>waldo::compare(bundeslaender_wgs84 %&gt;% sf::st_crs(), krankenhaeuser_wgs84 %&gt;% sf::st_crs())</code></pre>
<pre><code>## v No differences</code></pre>
<p>…und wir können sie gemeinsam grafisch darstellen:</p>
<pre class="r"><code>ggplot() +
  geom_sf(data = bundeslaender_wgs84, aes(geometry = geometry)) +
  geom_sf(data = krankenhaeuser_wgs84, aes(geometry = geometry))</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Die Krankenhäuser liegen allesamt im Ruhrgebiet. Es könnte also sinnvoll sein, die Hintergrundkarte auf Nordrhein-Westfalen zu beschränken. Man kann Datensätze auch innerhalb eines ggplot-geoms filtern:</p>
<pre class="r"><code>ggplot() +
  geom_sf(data = bundeslaender_wgs84 %&gt;%
            filter(GEN == &quot;Nordrhein-Westfalen&quot;), aes(geometry = geometry)) +
  geom_sf(data = krankenhaeuser_wgs84, aes(geometry = geometry))</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Der Krankenhäuser-Datensatz bietet Informationen zu den verschiedenen Typen der Krankenhäuser in der Variable <code>coll_name</code>. Wie sind die verschiedenen Krankenhaustypen geografisch verteilt?</p>
<p>Zunächst untersuchen wir, wie viele Krankenhaustypen es gibt und wie viele Krankenhäuser dem jeweiligen Typ angehören.</p>
<pre class="r"><code>krankenhaeuser_wgs84 %&gt;%
  as_tibble() %&gt;% #von sf-Objekt in tibble umwandeln
  count(coll_name) %&gt;%
  arrange(desc(n))</code></pre>
<pre><code>## # A tibble: 23 x 2
##    coll_name                   n
##    &lt;chr&gt;                   &lt;int&gt;
##  1 Krankenhäuser Allgemein   231
##  2 Fachklinik                 38
##  3 Psychiatrie                33
##  4 Innere Medizin             32
##  5 Orthopädie                 25
##  6 Kardiologie                22
##  7 Geriatrie                  18
##  8 Gynäkologie                17
##  9 Chirurgie                  16
## 10 Neurologie                 13
## # ... with 13 more rows</code></pre>
<p>Auf der Suche nach einem der 18 Krankenhäuser für Geriatrie im Ruhrgebiet? Natürlich, sind wir doch alle. Wo sind diese zu finden? Die Filterfunktionen innerhalb der ggplot-Befehle sind insbesondere für die schnelle Datenvisualisierung praktisch. Wir weisen der Farbe einen Indikator zu, der <code>TRUE</code> ist, wenn da Krankenhaus geriatrische Behandlungen anbietet und <code>FALSE</code> falls dem nicht so ist.</p>
<pre class="r"><code>ggplot() +
  geom_sf(data = bundeslaender_wgs84 %&gt;%
            filter(GEN == &quot;Nordrhein-Westfalen&quot;), aes(geometry = geometry)) +
  geom_sf(data = krankenhaeuser_wgs84, aes(geometry = geometry, color = coll_name %in% c(&quot;Geriatrie&quot;)))</code></pre>
<p><img src="Karten_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Weiterführende Links:</p>
<ul>
<li><a href="https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html">Drawing beautiful maps programmatically with R, sf and ggplot2</a></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
