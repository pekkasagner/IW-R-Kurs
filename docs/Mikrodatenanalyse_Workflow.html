<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Mikrodatenanalyse in R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">IW-R-Kurs</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="Ziele.html">Ziele</a>
</li>
<li>
  <a href="Einführung.html">Einführung</a>
</li>
<li>
  <a href="Tidyverse.html">Tidyverse</a>
</li>
<li>
  <a href="ggplot.html">ggplot2</a>
</li>
<li>
  <a href="Mikrodatenanalyse_Workflow.html">Mikrodatenanalyse</a>
</li>
<li>
  <a href="Karten.html">Karten und Geodaten</a>
</li>
<li>
  <a href="Interaktive_Abbildungen.html">Animationen und interaktive Abbildungen</a>
</li>
<li>
  <a href="Links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Mikrodatenanalyse in R</h1>

</div>


<hr />
<div id="ziele-der-sitzung" class="section level1">
<h1>Ziele der Sitzung</h1>
<ul>
<li>Setup eines effizienten Workflows für die Analyse von großen (Mikro-)Datensätzen</li>
<li>Mergen aus verschiedenen Datensätzen</li>
<li>Erstellen eines Arbeitsdatensatzes</li>
<li>Deskriptive Statistiken (numerisch und grafisch)</li>
<li>Gewichtete Statistiken</li>
</ul>
<hr />
</div>
<div id="setup-eines-effizienten-workflows" class="section level1">
<h1>Setup eines effizienten Workflows</h1>
<hr />
<div id="grundidee" class="section level2">
<h2>Grundidee</h2>
<p>Mikrodatensätze wirken häufig komplex. Grund hierfür sind sicherlich die Dimensionen der Datensätze. Viele Beobachtungen (Zeilen!) treffen auf viele Variablen (Spalten!)</p>
<p>Bei der Datenanalyse unterscheiden sich die Workflows in der Grundstruktur kaum von der Analyse anderer <em>kleinerer</em> Datensätze:</p>
<ol style="list-style-type: decimal">
<li>Daten einlesen</li>
<li>Daten säubern</li>
<li>Daten analysieren</li>
<li>Daten transformieren</li>
<li>Daten visualisieren</li>
<li>Daten kommunizieren</li>
</ol>
<p><img src="images/Workflow_Datenanalyse.png" /> Quelle: Vgl. <a href="https://bookdown.org/asmundhreinn/r4ds-master/wrangle-intro.html">R4DS</a></p>
<p>In der Praxis geht es meist nicht so geradlinig zu. Insbesondere bei großen Datensätzen kann es sinnvol sein, einige Zwischenschritte einzubauen.</p>
<p>Bei der Arbeit mit Mikrodatensätzen müssen in der Regel verschiedene Datensätze zu einem Arbeitsdatensatz zusammengeführt werden.</p>
<p>Das Zusammenführen der Daten kann, je nach Größe der Datensätze einige Zeit in Anspruch nehmen. Um zu Vermeiden, den Arbeitsdatensatz ständig auf’s Neue zusammenzufügen, sollte ein Arbeitsdatensatz gespeichert werden.</p>
<p>An diesem sollten, außer dem Zusammenführen der Daten, noch keine Änderungen vergenommen worden sein. Das Verändern der Daten erfolgt erst in einem späteren Schritt. Geht im Verlaufe der Datenanalyse etwas schief und der Arbeitsdatensatz wird ausversehen überschrieben, kann schnell die Erstversion wiederhergestellt werden. Ein erneutes Zusammenstellen der Daten wird vermieden.</p>
<p>Ein effizienter Workflow bei der Analyse großer Datenmengen aus verschiedenen Quellen könnte also so aussehen:</p>
<p><img src="images/Workflow_Datenanalyse_Mikrodaten.png" /> Quelle: Adaptiert von <a href="https://bookdown.org/asmundhreinn/r4ds-master/wrangle-intro.html">R4DS</a></p>
<hr />
</div>
<div id="ordnerstruktur" class="section level2">
<h2>Ordnerstruktur</h2>
<p>Ein effizienter Workflow beginnt bei einer effizienten Ordnerstruktur. Dabei sollte mir R-Projekten gearbeitet werden. Eine beispielhafte Ordnerstruktur könnte so aussehen:</p>
<pre><code>## Beispielordner_Mikrodatenanalyse
## +-- 01_Daten.R
## +-- 02_Analyse.R
## +-- data_in
## |   +-- phealth.dta
## |   +-- pl.sav
## |   \-- ppathl.dta
## \-- Projekt_Mikrodatenanalyse.Rproj</code></pre>
<p>Der Projektordner <code> Beispielordner_Mikrodatenanalyse </code> enthält alle relevanten Dateien. In der ersten Ebene liegt die .Rproj-Datei (<code>Projekt_Mikrodatenanalyse.Rproj</code>), .R-Dateien und Unterordner.</p>
<p>Ausgehend vom Projektordner, in dem die .Rproj-Datei liegt, können beliebige Unterordner gebildet werden. Alternativ zur obigen Struktur könnten die .R-Dateien auch in einen eigenen Ordner verschoben werden.</p>
<p>Andere Beispiele für Ordnerstrukturen finden sich zum Beispiel hier:</p>
<ul>
<li><p><a href="https://martinctc.github.io/blog/rstudio-projects-and-working-directories-a-beginner&#39;s-guide/">RStudio Projects and Working Directories: A Beginner’s Guide</a></p></li>
<li><p><a href="https://bookdown.org/lyzhang10/lzhang_r_tips_book/how-to-organize-a-project-folder.html">Bookdown: How to organize a project folder</a></p></li>
<li><p><a href="https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects">RStudio: Using Projects</a></p></li>
</ul>
<hr />
</div>
</div>
<div id="mikrodatenanalyse-praxisbeispiel" class="section level1">
<h1>Mikrodatenanalyse Praxisbeispiel</h1>
<div id="daten-einlesen" class="section level2">
<h2>Daten einlesen</h2>
<div id="problem" class="section level3">
<h3>Problem:</h3>
<p>Mikrodaten werden in der Regel (noch) nicht in einem R-Datenformat ausgeliefert. Häufig sind zunächst nur dta-Dateien (Stata) oder sav-Dateien (SPSS) verfügbar.</p>
<p>###Lösung:</p>
<p>Das Paket <code>haven</code> ermöglicht das Einlesen <em>fremder</em> Dateitypen.</p>
<pre class="r"><code>#Einmalig installieren
install.packages(&quot;haven&quot;)</code></pre>
<pre class="r"><code>#Laden
library(haven)</code></pre>
<p>Das Paket bietet verschiedene Funktionen, um fremde Dateiformate einzulesen, und diese zu speichern. Stata oder SPSS-Nutzer sind zudem die Arbeit mit <em>Labeln</em> gewohnt. In R wird dies standardmäßig nicht unterstützt. <code>haven</code> enthält verschiedene Funktionen, um Label zu definieren, ändern, löschen, usw.:</p>
<pre class="r"><code>#Liste aller Funktionen im Paket haven
ls(&quot;package:haven&quot;)</code></pre>
<pre><code>##  [1] &quot;as_factor&quot;                &quot;format_tagged_na&quot;        
##  [3] &quot;is.labelled&quot;              &quot;is_tagged_na&quot;            
##  [5] &quot;labelled&quot;                 &quot;labelled_spss&quot;           
##  [7] &quot;na_tag&quot;                   &quot;print_labels&quot;            
##  [9] &quot;print_tagged_na&quot;          &quot;read_dta&quot;                
## [11] &quot;read_por&quot;                 &quot;read_sas&quot;                
## [13] &quot;read_sav&quot;                 &quot;read_spss&quot;               
## [15] &quot;read_stata&quot;               &quot;read_xpt&quot;                
## [17] &quot;tagged_na&quot;                &quot;vec_arith.haven_labelled&quot;
## [19] &quot;write_dta&quot;                &quot;write_sas&quot;               
## [21] &quot;write_sav&quot;                &quot;write_xpt&quot;               
## [23] &quot;zap_empty&quot;                &quot;zap_formats&quot;             
## [25] &quot;zap_label&quot;                &quot;zap_labels&quot;              
## [27] &quot;zap_missing&quot;              &quot;zap_widths&quot;</code></pre>
<p>Bei der Arbeit mit Mikrodatensätzen liegt die erste Hürde im Zusammentragen der Datensätze. Beispielhaft soll dies anhand dreier Datensätze demonstriert werden. Die Datensätze basieren auf dem frei zugänglichen <a href="https://www.diw.de/de/diw_02.c.222838.de/soep_in_der_lehre.html">SOEP-Übungsdatensatz</a>. Dieser wurde um weitere Variablen ergänzt und für einen realistischeren Anwendungsfall aufgesplittet. Die Variablen sind verfremdet, beziehungsweise auf Zufallsbasis erstellt.</p>
<p>Für unsere Mikrodatenanalyse nutzen wir drei Datensätze: <code>ppathl.dta</code>, <code>pl.sav</code>, <code>phealth.dta</code>. Wir lesen diese mit den Befehlen <code>read_dta()</code> beziehungsweise <code>read_sav()</code> aus dem Paket <code>haven</code> ein.</p>
<pre class="r"><code>ppathl &lt;- read_dta(&quot;Beispielordner_Mikrodatenanalyse/data_in/ppathl.dta&quot;)
pl &lt;- read_sav(&quot;Beispielordner_Mikrodatenanalyse/data_in/pl.sav&quot;)
phealth &lt;- read_dta(&quot;Beispielordner_Mikrodatenanalyse/data_in/phealth.dta&quot;)</code></pre>
<p>Wie immer sollten die Datensätze zunächst inspiziert werden:</p>
<pre class="r"><code>ppathl</code></pre>
<pre><code>## # A tibble: 12,922 x 4
##    persnr  jahr          sex weight
##     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl+lbl&gt;  &lt;dbl&gt;
##  1 500575  2001 1 [weiblich]   467.
##  2 279067  2003 1 [weiblich]   860.
##  3 238927  2004 0 [maenlich]   343.
##  4 240595  2004 0 [maenlich]   869.
##  5  88977  2003 1 [weiblich]   367.
##  6 254006  2001 0 [maenlich]   314.
##  7 344281  2003 1 [weiblich]   892.
##  8 666151  2002 0 [maenlich]   908.
##  9 383792  2001 0 [maenlich]   793.
## 10 482355  2002 1 [weiblich]   648.
## # ... with 12,912 more rows</code></pre>
<pre class="r"><code>pl</code></pre>
<pre><code>## # A tibble: 12,922 x 7
##    persnr  jahr bildung anz_kind income  bula region
##     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; 
##  1 294354  2001    10.5        0  2456.    11 Land  
##  2 414129  2001    12          0  8143.     4 Stadt 
##  3 417490  2002    10.5        2  1051.     2 Land  
##  4 334726  2000     9          0  1276.    14 Stadt 
##  5 569347  2001    11          2  7047.    15 Stadt 
##  6 471291  2003    18          0  3711.    11 Land  
##  7 663550  2004    11          0  1815.    15 Stadt 
##  8 587268  2001    NA          0  3283.     6 Stadt 
##  9  75033  2000    13          1  1927.    13 Stadt 
## 10 180832  2003    12          0  1081.    13 Land  
## # ... with 12,912 more rows</code></pre>
<pre class="r"><code>phealth</code></pre>
<pre><code>## # A tibble: 12,276 x 6
##    persnr  jahr      gesund_org gesund_std               lebensz_org lebensz_std
##     &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl+lbl&gt;      &lt;dbl&gt;                 &lt;dbl+lbl&gt;       &lt;dbl&gt;
##  1 235585  2000 4 [Gut]              0.567  5 [5 Zufrieden: Skala 0~     -1.23  
##  2  74141  2000 3 [Zufriedenst~     -0.464  6 [6 Zufrieden: Skala 0~     -0.659 
##  3 512655  2001 4 [Gut]              0.567  6 [6 Zufrieden: Skala 0~     -0.659 
##  4 259440  2003 3 [Zufriedenst~     -0.464  8 [8 Zufrieden: Skala 0~      0.477 
##  5 527534  2002 4 [Gut]              0.567  9 [9 Zufrieden: Skala 0~      1.05  
##  6 510444  2001 1 [Schlecht]        -2.53   5 [5 Zufrieden: Skala 0~     -1.23  
##  7 396886  2001 2 [Weniger_gut]     -1.49   6 [6 Zufrieden: Skala 0~     -0.659 
##  8 246747  2002 5 [Sehr_gut]         1.60  10 [10 Zufrieden: Skala ~      1.61  
##  9 544752  2001 4 [Gut]              0.567  6 [6 Zufrieden: Skala 0~     -0.659 
## 10 152915  2000 5 [Sehr_gut]         1.60   7 [7 Zufrieden: Skala 0~     -0.0909
## # ... with 12,266 more rows</code></pre>
<p>Ein Teil der Variablen ist vom Typ <code>haven_labelled</code>, angezeigt durch <code>&lt;dbl+lbl&gt;</code>. Für Statanutzer ist dies nichts Neues. Dies bedeutet lediglich, dass die Variablen neben dem eigentlichen Variablennamen noch eine Kurzbeschreibung tragen. <code>&lt;dbl+lbl&gt;</code> zeigt an, dass die Variable numerisch ist (<code><dbl></code>) und ein Label trägt <code>&lt;+lbl&gt;</code>.</p>
<p>Um die drei Datensätze zusammenzufügen nutzen wir die beiden Matching-Variablen <code>persnr</code> und <code>jahr</code>.</p>
<p>Optional: Standardmäßig zeigt R keine Änderungen an Datensätzen in der Konsole an. Wer gerne Feedback für Datenmanipulationen und auch Mergevorgänge möchte, der kann hierfür das Paket <code>tidylog</code> nutzen. Das Paket bietet Informationen für eine Vielzahl an Datenmanipulationsfunktionen aus dem tidyverse.</p>
<pre class="r"><code>library(tidyverse)
library(tidylog)
ls(&quot;package:tidylog&quot;)</code></pre>
<pre><code>##  [1] &quot;add_count&quot;     &quot;add_tally&quot;     &quot;anti_join&quot;     &quot;count&quot;        
##  [5] &quot;distinct&quot;      &quot;distinct_all&quot;  &quot;distinct_at&quot;   &quot;distinct_if&quot;  
##  [9] &quot;drop_na&quot;       &quot;fill&quot;          &quot;filter&quot;        &quot;filter_all&quot;   
## [13] &quot;filter_at&quot;     &quot;filter_if&quot;     &quot;full_join&quot;     &quot;gather&quot;       
## [17] &quot;group_by&quot;      &quot;group_by_all&quot;  &quot;group_by_at&quot;   &quot;group_by_if&quot;  
## [21] &quot;inner_join&quot;    &quot;left_join&quot;     &quot;mutate&quot;        &quot;mutate_all&quot;   
## [25] &quot;mutate_at&quot;     &quot;mutate_if&quot;     &quot;pivot_longer&quot;  &quot;pivot_wider&quot;  
## [29] &quot;relocate&quot;      &quot;rename&quot;        &quot;rename_all&quot;    &quot;rename_at&quot;    
## [33] &quot;rename_if&quot;     &quot;rename_with&quot;   &quot;replace_na&quot;    &quot;right_join&quot;   
## [37] &quot;sample_frac&quot;   &quot;sample_n&quot;      &quot;select&quot;        &quot;select_all&quot;   
## [41] &quot;select_at&quot;     &quot;select_if&quot;     &quot;semi_join&quot;     &quot;slice&quot;        
## [45] &quot;slice_head&quot;    &quot;slice_max&quot;     &quot;slice_min&quot;     &quot;slice_sample&quot; 
## [49] &quot;slice_tail&quot;    &quot;spread&quot;        &quot;summarise&quot;     &quot;summarise_all&quot;
## [53] &quot;summarise_at&quot;  &quot;summarise_if&quot;  &quot;summarize&quot;     &quot;summarize_all&quot;
## [57] &quot;summarize_at&quot;  &quot;summarize_if&quot;  &quot;tally&quot;         &quot;tidylog&quot;      
## [61] &quot;top_frac&quot;      &quot;top_n&quot;         &quot;transmute&quot;     &quot;transmute_all&quot;
## [65] &quot;transmute_at&quot;  &quot;transmute_if&quot;  &quot;uncount&quot;       &quot;ungroup&quot;</code></pre>
<hr />
</div>
</div>
<div id="datensätze-zusammenführen" class="section level2">
<h2>Datensätze zusammenführen</h2>
<p><img src="images/Joins_1.png" /></p>
<p>Um Datensätze zusammenzuführen werden die <code>Mutating Joins</code>-Funktionen genutzt. Die vier Funktionen aus dem Paket <code>dplyr</code> welches Teil des <code>tidyverse</code> ist, sind:</p>
<ul>
<li><p><code>Neuer_Datensatz &lt;- left_join(Datensatz1, Datensatz2, by = c(“Matchingvariable1”, “Matchingvariable2”))</code>: Datensatz1 bleibt komplett erhalten und wird um Spalten von Datensatz2 ergänzt.</p></li>
<li><p><code>Neuer_Datensatz &lt;- right_join(Datensatz1, Datensatz2, by = c(“Matchingvariable1”, “Matchingvariable2”))</code>: Datensatz2 bleibt komplett erhalten und wird um Spalten von Datensatz1 ergänzt.</p></li>
<li><p><code>Neuer_Datensatz &lt;- inner_join(Datensatz1, Datensatz2, by = c(“Matchingvariable1”, “Matchingvariable2”))</code>: Nur die Beobachtungen behalten, bei denen dieselben Matchingvariablen in beiden Datensätzen auftauchen.</p></li>
<li><p><code>Neuer_Datensatz &lt;- full_join(Datensatz1, Datensatz2, by = c(“Matchingvariable1”, “Matchingvariable2”))</code>: Neuer Datensatz enthält sowohl Beobachtungen, die in beiden Datensätzen vorkommen als auch Einzelbeobachtungen, die nicht gematcht wurden.</p></li>
</ul>
<p><img src="images/Joins_2.png" /></p>
<p>Quelle: <a href="%22https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf%22">Data Wrangling Cheat Sheet</a></p>
<hr />
<p>##Reihenfolge des Zusammenfügens bei Mikrodatensätzen</p>
<p>Bei der Arbeit mit Mikrodatensätzen beginnt man in der Regel mit einem Basisdatensatz, in unserem Fall <code>ppathl</code>. Dieser enthält in der Regel alle Beobachtungen. Aufbauend auf diesem Datensatz werden weitere Informationen hinzugefügt. Wir wissen also, dass wir an <code>ppathl</code> alle anderen Datensätze dranspielen können. In unserem finalen Datensatz sind alle Zeilen aus <code>ppathl</code> enthalten, ergänzt um weitere Variablen aus den anderen Datensätzen. Wir nutzen also den <code>left_join</code>.</p>
<p>Um einen Arbeitsdatensatz aus mehreren Datensätzen zu erstellen, kann man schrittweise vorgehen:</p>
<pre class="r"><code>#1. Schritt
zwischendatensatz1 &lt;- left_join(ppathl, pl, by = c(&quot;persnr&quot;, &quot;jahr&quot;))</code></pre>
<pre class="r"><code>#2. Schritt
arbeitsdatensatz_mit_zwischenschritt &lt;- left_join(zwischendatensatz1, phealth, by = c(&quot;persnr&quot;, &quot;jahr&quot;))</code></pre>
<p>Wer sich sicher fühlt nutzt den Pipe-Befehl und kombiniert die beiden Schritte.</p>
<pre class="r"><code>library(tidyverse)
arbeitsdatensatz &lt;- ppathl %&gt;% #Ausgangsdatensatz ppathl
  left_join(pl, by = c(&quot;persnr&quot;, &quot;jahr&quot;)) %&gt;% #1. Schritt
  left_join(phealth, by = c(&quot;persnr&quot;, &quot;jahr&quot;)) #2. Schritt</code></pre>
<p>Das Ergebnis ist identisch:</p>
<pre class="r"><code>library(waldo)
waldo::compare(arbeitsdatensatz, arbeitsdatensatz_mit_zwischenschritt)</code></pre>
<pre><code>## v No differences</code></pre>
<p>An dieser Stelle bietet es sich an, den Arbeitsdatensatz oder vielleicht sogar alle bisher geladenen und erstellten Objekte (z.B. Datensätze) abzuspeichern. Mit <code>saveRDS</code> kann ein einzelnes R-Objekt gespeichert werden. <code>readRDS</code> lädt dieses ein.</p>
<pre class="r"><code># Einzelnes Objekt speichern:
saveRDS(object = arbeitsdatensatz, file = &quot;arbeitsdatensatz.rds&quot;)
# Einzelnes Objekt laden:
arbeitsdatensatz &lt;- readRDS(&quot;arbeitsdatensatz.rds&quot;)</code></pre>
<p>Sollen alle bisher erstellten Obejekte gespeichert werden, geschieht dies mit <code>save.image</code>. Geladen wird mit dem Befehl <code>load</code>.</p>
<pre class="r"><code># Gesamten Workspace speichern:
save.image(file = &quot;arbeitsdatensatz.RData&quot;)</code></pre>
<pre class="r"><code># Und wieder laden
load(&quot;arbeitsdatensatz.RData&quot;)</code></pre>
<hr />
<p>##Analyse von Mikrodaten</p>
<p>Die große Anzahl an Beobachtungen kann die (effiziente) Visualisierung von Mikrodaten erschweren und einige Visualisierungsformen bieten sich mehr an als andere. Entscheidend ist der Datentyp, der visualisiert werden soll.</p>
<p>Sollen lediglich aggregierte Werte, wie beispielsweise Mittelwerte, Quantile und Dispersionsmaße dargestellt werden, unterscheidet sich die Datenvisualisierung von Mikrodaten nicht von der von anderen Daten. Lediglich bei der Datenanalyse muss auf die Gewichtung der Daten geachtet werden.</p>
<p>###Gewichte (Hochrechnungsfaktoren) Um für die Grundgesamtheit repräsentative Ergebnisse zu erhalten, müssen die Daten aus der Stichprobe gewichtet werden. Wie immer kann ein gewünschtes Ergebnis, hier zum Beispiel die durchschnittlichen Einkommen im Jahr 2004, <em>händisch</em> berechnet werden.</p>
<pre class="r"><code>arbeitsdatensatz %&gt;%
  filter(jahr == 2004) %&gt;%
  summarise(income_mean_weighted = sum(income*weight)/sum(weight)) </code></pre>
<pre><code>## # A tibble: 1 x 1
##   income_mean_weighted
##                  &lt;dbl&gt;
## 1               15372.</code></pre>
<p>In der Regel hat sich jedoch schon jemand die Mühe gemacht und eine Funktion geschrieben:</p>
<pre class="r"><code>arbeitsdatensatz %&gt;%
  filter(jahr == 2004) %&gt;%
  summarise(income_mean_weighted = weighted.mean(x = income, w = weight))</code></pre>
<pre><code>## # A tibble: 1 x 1
##   income_mean_weighted
##                  &lt;dbl&gt;
## 1               15372.</code></pre>
<p>So bietet zum Beispiel das Paket <code>spatstat</code> Funktionen, die für die Berechnung deskriptiver, gewichteter Statistiken sinnvoll sind.</p>
<pre class="r"><code>library(spatstat)
ls(&quot;package:spatstat&quot;) %&gt;% 
  as_tibble() %&gt;% 
  filter(stringr::str_detect(value, &quot;weighted&quot;))</code></pre>
<pre><code>## # A tibble: 4 x 1
##   value             
##   &lt;chr&gt;             
## 1 weighted.median   
## 2 weighted.quantile 
## 3 weighted.var      
## 4 weightedclosepairs</code></pre>
<p>Die Anwendung dieser Funktionen funktioniert genau wie in unseren bisherigen Beispielen. Sind wir an der Entwicklung des gewichteten Medianeinkommens über die Zeit interessiert, bestimmen wir diese mit:</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  group_by(jahr) %&gt;% 
  summarise(income_weighted_median = spatstat::weighted.median(income, weight, na.rm = T)) %&gt;% 
  ungroup()</code></pre>
<pre><code>## # A tibble: 5 x 2
##    jahr income_weighted_median
##   &lt;dbl&gt;                  &lt;dbl&gt;
## 1  2000                  1971.
## 2  2001                  2064.
## 3  2002                  1964.
## 4  2003                  1957.
## 5  2004                  1993.</code></pre>
<p>Als Visualisierung:</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  group_by(jahr) %&gt;% 
  summarise(income_weighted_median = spatstat::weighted.median(income, weight, na.rm = T)) %&gt;% 
  ggplot(aes(x = factor(jahr), y = income_weighted_median, group = 1)) +
  geom_line(linetype = &quot;dashed&quot;) +
  geom_point(aes(color = factor(jahr)), size = 5) </code></pre>
<p><img src="Mikrodatenanalyse_Workflow_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Insbesondere bei Daten mit vielen Beobachtungen kann es spannend sein, die Verteilung der Variblen von Interesse zu visualisieren. Ein Klassiker ist der Boxplot.</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  ggplot(aes(x = factor(jahr), y = lebensz_org, color = factor(jahr), weight = weight)) +
  geom_boxplot()</code></pre>
<p><img src="Mikrodatenanalyse_Workflow_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Der klassiche Boxplot gibt zwar einige Hinweise auf die Verteilung der Daten, es geht aber auch schicker. Zum Beispiel mit <code>geom_jitter</code>.</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  ggplot(aes(x = factor(jahr), y = lebensz_org, color = factor(jahr), weight = weight)) +
  geom_jitter(alpha = 0.3) +
  geom_boxplot(alpha = 0.8, outlier.color = NA)</code></pre>
<p><img src="Mikrodatenanalyse_Workflow_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Oder mit <code>geom_violin</code>:</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  ggplot(aes(x = factor(jahr), y = income, color = factor(jahr), weight = weight)) +
  geom_jitter(alpha = 0.3) +
  geom_violin(alpha = 0.8, draw_quantiles = c(0.25, 0.5, 0.75)) +
  ylim(1000, 10000)</code></pre>
<p><img src="Mikrodatenanalyse_Workflow_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Eine weitere Option zur Visualisierung von Verteilungen ist <code>geom_density</code>.</p>
<pre class="r"><code>arbeitsdatensatz %&gt;% 
  filter(jahr == 2000) %&gt;% 
  ggplot() +
  geom_density(aes(x = income, weight = weight)) + #auch hier erlaubt weight eine Ausgabe gewichteter Graphen
  geom_density(aes(x = income), color = &quot;red&quot;) + #zum Vergleich der ungewichtete Graph
  xlim(0,20000)</code></pre>
<p><img src="Mikrodatenanalyse_Workflow_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
